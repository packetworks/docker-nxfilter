# This workflow checks version.txt against the current version generated by http://www.nxfilter.org/curver.php
# If the version string in version.txt differs from the generated string, 
# a build job is triggered and the string in version.txt is updated.

name: Generate Output

on:
  schedule:
    - cron:  '0 0 * * *'
  push:
    branches: [ nxfilter-pi-experimental ]
  pull_request:
    branches: [ nxfilter-pi-experimental ]
env:
  VERSION: ""

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-node@v1
    - name: Check version.txt against curver.php
      run: |
        echo "VERSION=$(curl http://www.nxfilter.org/curver.php)" >> $GITHUB_ENV
        if [[ $(< version.txt) != "$VERSION" ]]; 
        then echo "UPDATE=true" >> $GITHUB_ENV && curl http://www.nxfilter.org/curver.php > version.txt; 
        fi
        
    - name: Push back to branch
      uses: Automattic/action-commit-to-branch@master
      with:
        branch: 'nxfilter-pi-experimental'
        commit_message: 'GitHub Actions update version.txt'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
